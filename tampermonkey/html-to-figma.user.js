// ==UserScript==
// @name         HTML to Figma
// @namespace    laziji
// @version      0.1
// @description  HTML to Figma
// @author       辣子鸡
// @include      *://*/*
// @icon         none
// @grant        GM_registerMenuCommand
// @grant        GM_openInTab
// ==/UserScript==

(function () {
    var htmlToFigma=function(e){var t={};function n(o){if(t[o])return t[o].exports;var r=t[o]={i:o,l:!1,exports:{}};return e[o].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=e,n.c=t,n.d=function(e,t,o){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(o,r,function(t){return e[t]}.bind(null,r));return o},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=0)}([function(e,t,n){"use strict";function o(e,t){return 1===t.length?t[0]:t.reduce((t,n)=>{if(!t)return n;const o=r(n)[e],i=r(t)[e];if("left"===e||"top"===e){if(o<i)return n}else if(o>i)return n;return t},null)}function r(e){if(getComputedStyle(e).display.includes("inline")&&e.children.length){const t=e.getBoundingClientRect(),n=function(e){if(!e.length)return null;const{top:t}=r(o("top",e)),{left:n}=r(o("left",e)),{bottom:i}=r(o("bottom",e)),{right:l}=r(o("right",e));return{top:t,left:n,bottom:i,right:l,width:l-n,height:i-t}}(Array.from(e.children));return t.width>n.width?Object.assign(Object.assign({},n),{width:t.width,left:t.left,right:t.right}):n}return e.getBoundingClientRect()}n.r(t);const i=e=>e&&Array.isArray(e.children);function l(e,t,n){e&&(t(e,n),i(e)&&e.children.forEach(n=>l(n,t,e)))}function c(e){let t=e;do{const e=getComputedStyle(t);if("none"===e.display||"hidden"===e.visibility)return!0;if("visible"!==e.overflow&&t.getBoundingClientRect().height<1)return!0}while(t=t.parentElement);return!1}function s(e){let t=e instanceof Node&&e.nodeType===Node.TEXT_NODE?e.parentElement:e;const n=[];for(;t&&(t=t.parentElement);)n.push(t);return n}function a(e){return s(e).length}const d=e=>{if(!e)return null;const t=e.match(/([\d\.]+)px/),n=null==t?void 0:t[1];return n?{unit:"PIXELS",value:parseFloat(n)}:null};function u(e){if(!e)return null;const[t,n,o,r,i,l]=e.match(/rgba?\(([\d\.]+), ([\d\.]+), ([\d\.]+)(, ([\d\.]+))?\)/)||[],c=l&&0===parseFloat(l);return n&&o&&r&&!c?{r:parseInt(n)/255,g:parseInt(o)/255,b:parseInt(r)/255,a:l?parseFloat(l):1}:null}const f=/^[0-9]+[a-zA-Z%]+?$/,h=e=>{if(!/px$/.test(e)&&"0"!==e)return 0;const t=parseFloat(e);return isNaN(t)?0:t},p=e=>{if(e.startsWith("rgb")){const t=e.match(/(rgba?\(.+?\))(.+)/);t&&(e=(t[2]+" "+t[1]).trim())}const t=e.split(/\s(?![^(]*\))/),n=t.includes("inset"),o=t.slice(-1)[0],r=(e=>"0"===e||f.test(e))(o)?"rgba(0, 0, 0, 1)":o,i=t.filter(e=>"inset"!==e).filter(e=>e!==r).map(h),[l,c,s,a]=i;return{inset:n,offsetX:l,offsetY:c,blurRadius:s,spreadRadius:a,color:r}};function g(e,t,n){e.data||(e.data={}),e.data[t]=n}const m=["opacity","backgroundColor","border","borderTop","borderLeft","borderRight","borderBottom","borderRadius","backgroundImage","borderColor","boxShadow"];const y=e=>e[0].toUpperCase()+e.substring(1),b=({borderWidth:e,borderType:t,borderColor:n})=>e&&"0"!==e&&"none"!==t&&n;function E({dir:e,rect:t,computedStyle:n,el:o}){const r=n["border"+y(e)];if(r){const n=r.match(/^([\d\.]+)px\s*(\w+)\s*(.*)$/);if(n){const[r,i,l,c]=n;if(b({borderWidth:i,borderType:l,borderColor:c})){const n=u(c);if(n){const r=["top","bottom"].includes(e)?t.width:parseFloat(i),l=["left","right"].includes(e)?t.height:parseFloat(i),c={type:"SOLID",color:{r:n.r,b:n.b,g:n.g},opacity:n.a||1};return{ref:o,type:"RECTANGLE",x:"left"===e?t.left-r:"right"===e?t.right:t.left,y:"top"===e?t.top-l:"bottom"===e?t.bottom:t.top,width:r,height:l,fills:[c]}}}}}}const x=e=>{for(const t of Array.from(e.querySelectorAll("use")))try{const e=t.href.baseVal,n=document.querySelector(e);n&&(t.outerHTML=n.innerHTML)}catch(e){console.warn("Error querying <use> tag href",e)}},S=({node:e})=>{var t;const n=(null===(t=e.textContent)||void 0===t?void 0:t.trim())||"";if(!n.length)return;const o=e.parentElement;if(o){if(c(o))return;const t=getComputedStyle(o),r=document.createRange();r.selectNode(e);const i=(e=>"symbol"==typeof e?null:JSON.parse(JSON.stringify(e)))(r.getBoundingClientRect()),l=d(t.lineHeight);if(r.detach(),l&&i.height<l.value){const e=l.value-i.height;i.top-=e/2,i.height=l.value}if(i.height<1||i.width<1)return;const s={x:Math.round(i.left),ref:e,y:Math.round(i.top),width:Math.round(i.width),height:Math.round(i.height),type:"TEXT",characters:n.replace(/\s+/g," ")},a=[],f=u(t.color);f&&a.push({type:"SOLID",color:{r:f.r,g:f.g,b:f.b},opacity:f.a||1}),a.length&&(s.fills=a);const h=d(t.letterSpacing);h&&(s.letterSpacing=h),l&&(s.lineHeight=l);const{textTransform:p}=t;switch(p){case"uppercase":s.textCase="UPPER";break;case"lowercase":s.textCase="LOWER";break;case"capitalize":s.textCase="TITLE"}const g=d(t.fontSize);return g&&(s.fontSize=Math.round(g.value)),t.fontFamily&&(s.fontFamily=t.fontFamily),["underline","strikethrough"].includes(t.textDecoration)&&(s.textDecoration=t.textDecoration.toUpperCase()),["left","center","right","justified"].includes(t.textAlign)&&(s.textAlignHorizontal=t.textAlign.toUpperCase()),s}},T=({layer:e,root:t})=>{let n=null;try{l(t,t=>{if(t&&t.children&&t.children.includes(e))throw n=t,"DONE"})}catch(e){"DONE"===e||console.error(e instanceof Error?e.message:e)}return n},M=({root:e,layers:t})=>{e.children=t.slice(1),(({root:e,layers:t})=>{const n=new WeakMap;t.forEach(e=>{e.ref&&n.set(e.ref,e)});let o=!0,c=0;for(;o;){if(o=!1,c++>1e4){console.error("Too many tree iterations 1");break}l(e,(t,r)=>{const l=t.ref;let c=l&&l.parentElement||null;do{if(c===document.body)break;if(c&&c!==document.body){const l=n.get(c);if(l===r)break;if(l&&l!==e){if(!i(l)){let i=l.ref;i&&i instanceof Node&&i.nodeType===Node.TEXT_NODE&&(i=i.parentElement);const s={type:"FRAME",clipsContent:!!(i instanceof Element&&"visible"!==getComputedStyle(i).overflow),x:l.x,y:l.y,width:l.width,height:l.height,ref:l.ref,backgrounds:[],children:[l,t]},a=T({layer:l,root:e});if(!a){console.warn("\n\nCANT FIND PARENT\n",JSON.stringify(Object.assign(Object.assign({},l),{ref:null})));continue}if(r){const e=r.children.indexOf(t);r.children.splice(e,1)}delete l.ref;const d=a.children.indexOf(l);return n.set(c,s),a.children.splice(d,1,s),void(o=!0)}if(r){const e=r.children.indexOf(t);return r.children.splice(e,1),l.children.push(t),void(o=!0)}}}}while(c&&(c=c.parentElement))})}let d=!0,u=0;for(;d;){if(u++>1e4){console.error("Too many tree iterations 2");break}d=!1,l(e,(e,t)=>{if(!d&&"FRAME"===e.type){const t=e.ref;if(e.children&&e.children.length>2){const o=e.children&&e.children.map(e=>e.ref);let i=e.ref,l=a(i);for(const t of o){const n=o.filter(e=>e!==t),r=s(t);for(const t of n){const n=s(t);for(const t of n)if(r.includes(t)&&e.ref.contains(t)){const e=a(t);e>l&&(i=t,l=e)}}}if(i&&i!==e.ref){const o=e.children.filter(e=>i.contains(e.ref));if(o.length!==e.children.length){const l=r(i),c={type:"FRAME",clipsContent:!!(i instanceof Element&&"visible"!==getComputedStyle(i).overflow),ref:i,x:l.left,y:l.top,width:l.width,height:l.height,backgrounds:[],children:o};n.set(i,t);let s=e.children.length-1;for(const t of o){const n=e.children.indexOf(t);n>-1&&n<s&&(s=n)}e.children.splice(s,0,c);for(const t of o){const n=e.children.indexOf(t);n>-1&&e.children.splice(n,1)}d=!0}}}}})}l(e,e=>{if("FRAME"===e.type||"GROUP"===e.type){const{x:t,y:n}=e;(t||n)&&l(e,o=>{o!==e&&(o.x=o.x-t,o.y=o.y-n)})}})})({root:e,layers:t});const n=[e];return function(e){e.forEach(e=>{l(e,e=>{if("SVG"===e.type)e.constraints={horizontal:"CENTER",vertical:"MIN"};else{const t=e.ref;if(t){const n=t instanceof HTMLElement?t:t.parentElement,o=null==n?void 0:n.parentElement;if(n&&o){const t=n.style.display;n.style.setProperty("display","none","!important");let r=getComputedStyle(n);const i=null==r?void 0:r.width.trim().endsWith("px"),l=null==r?void 0:r.height.trim().endsWith("px");n.style.display=t;const c=getComputedStyle(o);let s="auto"===r.marginLeft,a="auto"===r.marginRight,d="auto"===r.marginTop,u="auto"===r.marginBottom;if(r=getComputedStyle(n),["absolute","fixed"].includes(r.position)&&g(e,"position",r.position),l&&g(e,"heightType","fixed"),i&&g(e,"widthType","fixed"),r.display&&r.display.includes("inline")){const t=c.textAlign;"center"===t?(s=!0,a=!0):"right"===t&&(s=!0),"middle"===r.verticalAlign?(d=!0,u=!0):"bottom"===r.verticalAlign&&(d=!0,u=!1),g(e,"widthType","shrink")}const f="flex"===c.display&&("row"===c.flexDirection&&c.justifyContent||"column"===c.flexDirection&&c.alignItems);"center"===f?(s=!0,a=!0):f&&(f.includes("end")||f.includes("right"))&&(s=!0,a=!1);const h="flex"===c.display&&("column"===c.flexDirection&&c.justifyContent||"row"===c.flexDirection&&c.alignItems);"center"===h?(d=!0,u=!0):h&&(h.includes("end")||h.includes("bottom"))&&(d=!0,u=!1),"TEXT"===e.type&&("center"===r.textAlign?(s=!0,a=!0):"right"===r.textAlign&&(s=!0,a=!1)),e.constraints={horizontal:s&&a?"CENTER":s?"MAX":"SCALE",vertical:u&&d?"CENTER":d?"MAX":"MIN"}}}else e.constraints={horizontal:"SCALE",vertical:"MIN"}}})})}(n),n};n.d(t,"htmlToFigma",function(){return R});const v=e=>{const t=e=>{var n;return Array.from((null===(n=e.shadowRoot)||void 0===n?void 0:n.querySelectorAll("*"))||[]).reduce((e,n)=>[...e,n,...t(n)],[])};return Array.from(e.querySelectorAll("*")).reduce((e,n)=>[...e,n,...t(n)],[])};const w=e=>{const t=[];if(c(e))return[];if(e instanceof SVGSVGElement)return t.push((e=>{const t=e.getBoundingClientRect();return{type:"SVG",ref:e,svg:e.outerHTML,x:Math.round(t.left),y:Math.round(t.top),width:Math.round(t.width),height:Math.round(t.height)}})(e)),t;if(e instanceof SVGElement)return[];if(e.parentElement instanceof HTMLPictureElement&&e instanceof HTMLSourceElement||e instanceof HTMLPictureElement)return[];const n=function(e,t){if(!(e instanceof HTMLElement||e instanceof SVGElement))return{};const n=getComputedStyle(e,t),o=n.color,r={transform:"none",opacity:"1",borderRadius:"0px",backgroundImage:"none",backgroundPosition:"0% 0%",backgroundSize:"auto",backgroundColor:"rgba(0, 0, 0, 0)",backgroundAttachment:"scroll",border:"0px none "+o,borderTop:"0px none "+o,borderBottom:"0px none "+o,borderLeft:"0px none "+o,borderRight:"0px none "+o,borderWidth:"0px",borderColor:o,borderStyle:"none",boxShadow:"none",fontWeight:"400",textAlign:"start",justifyContent:"normal",alignItems:"normal",alignSelf:"auto",flexGrow:"0",textDecoration:"none solid "+o,lineHeight:"normal",letterSpacing:"normal",backgroundRepeat:"repeat",zIndex:"auto"};return function(e,t){const n={};return t.forEach(t=>{e[t]&&e[t]!==r[t]&&(n[t]=e[t])}),n}(n,m)}(e),o=getComputedStyle(e);if((function(e){return Object.keys(e).length}(n)||e instanceof HTMLImageElement||e instanceof HTMLVideoElement)&&"none"!==o.display){const n=r(e);if(n.width>=1&&n.height>=1){const r=[],i=u(o.backgroundColor);if(i){const e={type:"SOLID",color:{r:i.r,g:i.g,b:i.b},opacity:i.a||1};r.push(e)}const l={type:"RECTANGLE",ref:e,x:Math.round(n.left),y:Math.round(n.top),width:Math.round(n.width),height:Math.round(n.height),fills:r},c=(({computedStyle:{border:e}})=>{if(e){const t=e.match(/^([\d\.]+)px\s*(\w+)\s*(.*)$/);if(t){const[e,n,o,r]=t;if(b({borderWidth:n,borderType:o,borderColor:r})){const e=u(r);if(e)return{strokes:[{type:"SOLID",color:{r:e.r,b:e.b,g:e.g},opacity:e.a||1}],strokeWeight:Math.round(parseFloat(n))}}}}})({computedStyle:o});if(c&&Object.assign(l,c),!l.strokes)for(const r of["top","left","right","bottom"]){const i=E({dir:r,rect:n,computedStyle:o,el:e});i&&t.push(i)}const s=(({computedStyle:e,el:t})=>{if(t instanceof SVGSVGElement){return{url:`data:image/svg+xml,${encodeURIComponent(t.outerHTML.replace(/\s+/g," "))}`,type:"IMAGE",scaleMode:"FILL",imageHash:null}}{const n={type:"IMAGE",scaleMode:"contain"===e.objectFit?"FIT":"FILL",imageHash:null};if(t instanceof HTMLImageElement){const e=t.currentSrc;if(e)return Object.assign({url:e},n)}else if(t instanceof HTMLVideoElement){const e=t.poster;if(e)return Object.assign({url:e},n)}}if(e.backgroundImage&&"none"!==e.backgroundImage){const t=e.backgroundImage.match(/url\(['"]?(.*?)['"]?\)/),n=null==t?void 0:t[1];if(n)return{url:n,type:"IMAGE",scaleMode:"contain"===e.backgroundSize?"FIT":"FILL",imageHash:null}}})({computedStyle:o,el:e});s&&(r.push(s),l.name="IMAGE");const a=(({computedStyle:{boxShadow:e}})=>{if(e&&"none"!==e){const t=p(e),n=u(t.color);if(n){return[{color:n,type:"DROP_SHADOW",radius:t.blurRadius,blendMode:"NORMAL",visible:!0,offset:{x:t.offsetX,y:t.offsetY}}]}}})({computedStyle:o});a&&(l.effects=a);const f=(({computedStyle:e})=>{const t=d(e.borderTopLeftRadius),n=d(e.borderTopRightRadius),o=d(e.borderBottomRightRadius),r=d(e.borderBottomLeftRadius);return Object.assign(Object.assign(Object.assign(Object.assign({},t?{topLeftRadius:t.value}:{}),n?{topRightRadius:n.value}:{}),o?{bottomRightRadius:o.value}:{}),r?{bottomLeftRadius:r.value}:{})})({computedStyle:o});Object.assign(l,f),t.push(l)}}return t};function R(e="body",t=!1,n=!1){n&&console.time("Parse dom");const o=[],r=e instanceof HTMLElement?e:document.querySelector(e||"body");if(r){x(r),v(r).forEach(e=>{const t=w(e);o.push(...t)});const e=function(e){let t=null;const n=[],o=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null);for(;t=o.nextNode();)n.push(t);return n}(r);for(const t of e){const e=S({node:t});e&&o.push(e)}}const i={type:"FRAME",width:Math.round(window.innerWidth),height:Math.round(document.documentElement.scrollHeight),x:0,y:0,ref:document.body};o.unshift(i);const c=t?M({layers:o,root:i}):o;return function({layers:e,root:t}){e.concat([t]).forEach(e=>{l(e,e=>{delete e.ref})})}({layers:c,root:i}),n&&(console.info("\n"),console.timeEnd("Parse dom")),c}}]);

    function download(data, name) {
        let a = document.createElement('a');
        a.download = name;
        let blob = new Blob([data]);
        a.href = URL.createObjectURL(blob);
        a.click();
    }

    function imgURLToDataURL(url) {
        return new Promise((resolve, reject) => {
            let img = document.createElement('img');
            img.src = url
            img.crossOrigin = 'anonymous'
            img.onload = () => {
                let canvas = document.createElement("canvas");
                canvas.width = img.width;
                canvas.height = img.height;
                let ctx = canvas.getContext("2d");
                ctx.drawImage(img, 0, 0, img.width, img.height);
                let dataURL = canvas.toDataURL("image/png");
                resolve(dataURL);
            }
        })
    }


    function capture() {
        let data = { layers: htmlToFigma.htmlToFigma(document.body) };
        download(JSON.stringify(data), `${location.host.replace(".", "-")}.figma.json`)
    }

    function captureAppendCache() {
        let data = { layers: htmlToFigma.htmlToFigma(document.body) };
        let ts = [];
        for (let layer of data.layers) {
            for (let item of layer.fills || []) {
                if (item.type === "IMAGE" && item.url.indexOf("http") === 0) {
                    ts.push(imgURLToDataURL(item.url).then(dataURL => {
                        item.url = dataURL
                    }))
                }
            }
        }
        Promise.all(ts).then(() => {
            download(JSON.stringify(data), `${location.host.replace(".", "-")}.figma.json`)
        })
    }


    GM_registerMenuCommand("下载页面", () => capture());
    GM_registerMenuCommand("下载页面（缓存图片）", () => captureAppendCache());
    GM_registerMenuCommand("辣子鸡的其他插件", () => GM_openInTab("https://github-laziji.github.io/plugins/"));

})();